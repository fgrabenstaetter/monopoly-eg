<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: game/bid.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: game/bid.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Constants = require('../lib/constants');

class Bid {

    static idCounter = 0;

    /**
     * @param game Le jeu contenant l'enchère
     * @param id l'identifiant unique d'une enchère
     * @returns l'enchère si elle a été trouvée, faux sinon
     */
    static bidByID (game, id) {
        for (const bid of game.bids) {
            if (bid.id === id)
                return bid;
        }
        return false;
    }

    /**
     * @param bid l'enchère à supprimer
     * @returns true si elle a été supprimée, faux sinon
     */
    static delBid (bid) {
        const ind = bid.game.bids.indexOf(bid);
        if (ind === -1)
            return false;
        if (bid.manual)
            bid.game.alreadyOneManualBid = false;

        bid.game.bids.splice(ind, 1);
        return true;
    }

    /**
     * @param property La propriété à mettre aux enchères
     * @param amountAsked Le prix initial de l'enchère
     * @param game Le jeu contenant l'enchère
     * @param manual Enchère manuelle ou automatique
     */
    constructor (property, amountAsked, game, manual = false) {
        this.id                   = Bid.idCounter ++;
        this.player               = null;
        this.property             = property;
        this.initialPropertyOwner = property.owner;
        this.amountAsked          = amountAsked;
        this.game                 = game;
        this.manual               = manual;
        this.text                 = this.property.name;
        this.nBidsOnProperty      = [];
        this.lastOverbids         = []
        this.game.bids.push(this);
        setTimeout(this.expired.bind(this), Constants.GAME_PARAM.BID_EXPIRE_AFTER);

        if (manual)
            this.game.alreadyOneManualBid = true;

        const msg = this.property.name;
        this.game.GLOBAL.network.io.to(this.game.name).emit('gameBidRes', {
            bidID           : this.id,
            playerID        : null,
            text            : msg,
            propertyID      : this.property.id,
            propertyOwnerID : this.property.owner ? this.property.owner.id : null,
            price           : this.amountAsked
        });
    }

    //Test réalisé dans network
    /**
     * @param player Le joueur qui surrenchéri
     * @param amount Le montant du surrenchérissement
     * @returns true si le joueur a réussi à surrenchérir, faux sinon
     */
    updateBid (player, amount) {
        if (this.nBidsOnProperty.indexOf(player.id) === -1)
            this.nBidsOnProperty.push(player.id);

        let targetMaxLen = 0;
        for (const player of this.game.players) {
            if (player.connected &amp;&amp; !player.failure &amp;&amp; player !== this.initialPropertyOwner)
                targetMaxLen ++;
        }

        if (this.property.owner !== this.initialPropertyOwner) {
            this.expired();
            return false;
        }

        if (amount &lt;= this.amountAsked) {
            if (this.nBidsOnProperty.length === targetMaxLen)
                this.expired();

            return true;
        }

        if (this.player)
            this.lastOverbids.push({ player: this.player, amountAsked: this.amountAsked });

        this.amountAsked = amount;
        this.player = player;


        if (this.nBidsOnProperty.length === targetMaxLen)
            this.expired();

        return true;
    }

    /**
     * Fin d'une enchère
     */
    expired () {
        const curBid = Bid.bidByID(this.game, this.id);
        if (!curBid)
            return;

        while (true) {
            if ((this.player &amp;&amp; ((this.player.money &lt; this.amountAsked) || this.player.failure)) || this.initialPropertyOwner !== this.property.owner) {
                this.player = null;
                if (this.lastOverbids.length > 0) {
                    const last = this.lastOverbids.pop();
                    this.player = last.player;
                    this.amountAsked = last.amountAsked;
                } else
                    break;
            } else
                break;
        }

        const oldOwner = this.property.owner ? this.property.owner : this.game.bank;

        if (this.player) {
            this.player.loseMoney(this.amountAsked);
            oldOwner.addMoney(this.amountAsked);
            oldOwner.delProperty(this.property);
            this.player.addProperty(this.property);
        }

        Bid.delBid(this);

        this.game.GLOBAL.network.io.to(this.game.name).emit('gameBidEndedRes', {
            bidID                 : this.id,
            propertyID            : this.property.id,
            propertyOldOwnerID    : oldOwner === this.game.bank ? null : oldOwner.id,
            playerID              : this.player ? this.player.id : null,
            playerMoney           : this.player ? this.player.money : null,
            price                 : this.amountAsked,
            bankMoney             : this.game.bank.money,
            propertyOldOwnerMoney : oldOwner ? oldOwner.money : null
        });
    }
}

module.exports = Bid;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Bank.html">Bank</a></li><li><a href="Bid.html">Bid</a></li><li><a href="Card.html">Card</a></li><li><a href="Cell.html">Cell</a></li><li><a href="Chat.html">Chat</a></li><li><a href="Deck.html">Deck</a></li><li><a href="Game.html">Game</a></li><li><a href="Lobby.html">Lobby</a></li><li><a href="Matchmaking.html">Matchmaking</a></li><li><a href="Network.html">Network</a></li><li><a href="Offer.html">Offer</a></li><li><a href="Player.html">Player</a></li><li><a href="Property.html">Property</a></li><li><a href="PublicCompany.html">PublicCompany</a></li><li><a href="Street.html">Street</a></li><li><a href="Tax.html">Tax</a></li><li><a href="TrainStation.html">TrainStation</a></li><li><a href="User.html">User</a></li><li><a href="UserManager.html">UserManager</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Sun May 03 2020 11:35:16 GMT+0200 (GMT+02:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
