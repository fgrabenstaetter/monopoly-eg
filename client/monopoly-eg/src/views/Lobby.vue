<template>
  <div class="lobby">
        <div class="background-container"></div>
        <div class="lobby-ui-container">
            <div class="container">
                <div class="row profile-container">
                    <div class="profile-row">
                        <div class="username" data-id="">{{loggedUser.nickname}}</div>
                        <i id="open-user-settings" class="fa fa-pen" data-toggle="modal" data-target="#userSettingsModal"></i>
                        <img class="user-avatar" data-id="" :src="loggedUser.avatar">
                        <i class="fa fa-cog open-settings ml-2" aria-hidden="true" data-toggle="modal" data-target="#optionsModal"></i>
                        <i @click="logout" class="logout-btn fas fa-sign-out-alt" title="Déconnexion"></i>
                    </div>
                </div>
            </div>
            <div class="container lobby-top-row">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card box friendlist">
                            <div class="card-header">
                                AMIS <i class="fas fa-user-plus float-right mt-1" style="cursor:pointer;" data-toggle="modal" data-target="#addFriendModal" title="Ajouter un nouvel ami"></i>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <input v-model="searchFriends" type="text" class="form-control" placeholder="Rechercher un ami...">
                                    <i class="fa fa-search"></i>
                                </div>
                                <div class="friends-entries-container">
                                    <div v-for="friend in friendsInvitations" :key="friend.id" class="friend-request">
                                        <div class="friend-request-text">
                                            <span>{{friend.nickname}}</span> souhaite vous ajouter à sa liste d'amis
                                        </div>
                                        <div @click="acceptFriendInvitation(friend.id, friend.nickname)" class="accept-button">accepter</div>
                                        <div @click="rejectFriendInvitation(friend.id, friend.nickname)" class="deny-button">refuser</div>
                                    </div>
                                    <div id="friendList">
                                        <div v-for="friend in friends" :key="friend.id" class="friend-entry">
                                            <img v-if="friend.showInSearch" class="friends-avatar" :src="friend.avatar">
                                            <div v-if="friend.showInSearch" class="friends-name">{{friend.nickname}}</div>
                                            <div v-if="friend.showInSearch" class="friend-action" @click="inviteFriendInLobby(friend.id)">inviter</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card box grouplist">
                            <div class="card-header">
                                MON GROUPE
                            </div>
                            <div class="card-body">
                                <div class="group-entries-container">
                                    <div v-for="player in players" :key="player.id" class="group-entry" :class="{'leader': player.id==hostID}">
                                        <img class="friends-avatar" :src="player.avatar">
                                        <div class="friends-name">{{player.nickname}}</div>
                                        <div v-if="loggedUser.id == hostID && player.id != loggedUser.id" class="friend-action" @click="kickPlayerFromLobby(player.id)"><i class="fas fa-times"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card box grouplist">
                            <div class="card-header">
                                PARAMÈTRES
                            </div>
                            <div class="card-body pl-3 pr-3 pt-3 pb-3">
                                <div class="game-time-container">
                                    <div class="game-time-selector">
                                        <button v-if="leftGameTime" class="arrow-left" @click="leftGameTimeClick"></button>
                                        <div id="gameTime">{{gameTime}}</div>
                                        <button v-if="rightGameTime" class="arrow-right" @click="rightGameTimeClick"></button>
                                    </div>
                                </div>
                                <div class="nb-joueurs-container">
                                    <div class="nb-joueurs-selector">
                                        <button v-if="leftNbJ" class="arrow-left" @click="leftNbJClick"></button>
                                        <div id="nbJoueurs">{{nbPlayers}}</div>
                                        <button v-if="rightNbJ" class="arrow-right" @click="rightNbJClick"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container lobby-bottom-row">
                <div class="row">
                    <div class="col-md-4">
                        <chat-io ref="chat"></chat-io>
                    </div>
                    <div class="col-md-8 text-right play-button-container">
                        <a class="btn btn-primary stylized play-button" :class="{'disabled': playBtn.disabled}" @click="play">{{playBtn.text}}</a>
                    </div>
                    <div class="col-md-4 notification-container" id="inviteGameContainer">
                        <div v-for="invitation in lobbyInvitations" :key="invitation.id" class="card notification lobby-invitation" :id="invitation.id">
                            <div class="card-header">
                                INVITATION
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{invitation.friendNickname}} vous invite à rejoindre sa partie</p>
                                <button class="btn btn-primary" @click="acceptLobbyInvitation(invitation.id)">ACCEPTER</button>
                                <button class="btn btn-secondary" @click="rejectLobbyInvitation(invitation.id)">REFUSER</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edition du profil -->
            <div class="modal" id="userSettingsModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog animated bounceIn" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Édition du profil</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="cursor: pointer;">
                                <span aria-hidden="true" style="cursor: pointer;">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form @submit.prevent="updateProfile" class="text-left">
                                <div class="form-group">
                                    <label>Pseudo</label>
                                    <input v-model="editProfile.nickname" type="text" class="form-control" autocomplete="off" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse email</label>
                                    <input v-model="editProfile.email" type="email" class="form-control" autocomplete="off" required>
                                </div>
                                <div class="form-group">
                                    <label>Nouveau mot de passe</label>
                                    <input v-model="editProfile.password" type="password" class="form-control" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label for="avatar">Avatar <small>(JPG, Max 1Mo, format carré de préférence)</small></label>
                                    <input type="file" class="form-control-file" id="avatar" @change="processAvatar($event)">
                                </div>
                                <button v-if="editProfile.loading" type="submit" class="btn btn-primary" disabled>Chargement...</button>
                                <button v-else type="submit" class="btn btn-primary">Enregistrer</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ajouter un ami -->
            <div class="modal" id="addFriendModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog animated bounceIn" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ajouter un ami</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="cursor: pointer;">
                                <span aria-hidden="true" style="cursor: pointer;">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form @submit.prevent="addFriend">
                                <div class="form-group">
                                    <input v-model="addFriendForm.nickname" type="text" class="form-control" placeholder="Pseudo..." autocomplete="off" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Ajouter</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal -->
            <div class="modal-container" id="modal">
                <!--<div class="modal fade" id="Unknown67Modal" tabindex="-1" role="dialog" aria-labelledby="Unknown67ModalLabel" aria-hidden="true" data-id="1">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="Unknown67ModalLabel">Unknown67</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <button class="btn btn-danger delete-friend-button" data-id="1">supprimer</button>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary">Save changes</button>
                            </div>
                        </div>
                    </div>
                </div>-->
            </div>

        </div>

        <!-- Resolution overlay -->
        <div class="resolution-overlay-container">
            <div>
                Oups... c'est petit ici
                <br />Pense à étendre la fenêtre du jeu pour en profiter pleinement!
            </div>
        </div>

        <!-- Game settings modal -->
        <game-settings-modal :socket="socket" :loggedUser="loggedUser" env="lobby"></game-settings-modal>

        <full-screen-loader v-if="loading"></full-screen-loader>

    </div>

</template>

<script>
import {Howl} from 'howler';
import io from 'socket.io-client';
import FullScreenLoader from '../components/FullScreenLoader';
import ChatIO from '../components/ChatIO';
import GameSettingsModal from '../components/GameSettingsModal';
import $ from 'jquery';
import * as SocketIOFileUpload from 'socketio-file-upload';

/**
 * @vuese
 * @group Views
 * Ecran de lobby : profil du joueur, gestion des amis, paramètres de la partie, matchmaking, etc.
 */
export default {
    name: 'Lobby',
    components: {
        // @vuese
        // Ecran de chargement
        'full-screen-loader': FullScreenLoader,
        // @vuese
        // Système de chat
        'chat-io': ChatIO,
        // @vuese
        // Modal de paramètres
        'game-settings-modal': GameSettingsModal
    },
    data() {
        return {
            // @vuese
            // Utilisateur actuelement connecté (récupéré du store)
            loggedUser: this.$store.getters.loggedUser,
            // @vuese
            // Socket utilisé pour les connexions
            socket: null,
            // @vuese
            // Bouton "Jouer" ({ text: string, loading: bool, disabled: bool })
            playBtn: {
                text: "JOUER !",
                loading: false,
                disabled: true
            },
            // @vuese
            // Formulaire d'ajout d'ami ({ nickname: string })
            addFriendForm: {
                nickname: ""
            },
            // @vuese
            // Formulaire d'édition du profil ({ nickname: string, email: string, password: string })
            editProfile: {
                nickname: '',
                email: '',
                password: ''
            },
            // @vuese
            // Gestionaire d'eupload d'image (pour l'avatar, cf. socketio-file-upload)
            siofu: null,
            // @vuese
            // Indique si le lobby est en chargement (bool)
            loading: false,
            // @vuese
            // Liste des joueurs dans le lobby ('Mon groupe') (liste d'objets 'player')
            players: [],
            // @vuese
            // Liste d'amis
            friends: [],
            // @vuese
            // Liste d'invitations d'amis
            friendsInvitations: [],
            // @vuese
            // ID de l'hôte
            hostID: null,
            // @vuese
            // Flèche 'changement de joueurs' de gauche affichée (bool)
            leftNbJ: false,
            // @vuese
            // Flèche 'changement de joueurs' de droite affichée (bool)
            rightNbJ: false,
            // @vuese
            // Flèche 'changement de temps' de gauche affichée (bool)
            leftGameTime: false,
            // @vuese
            // Flèche 'changement de temps' de droite affichée (bool)
            rightGameTime: false,
            // @vuese
            // Temps souhaité pour la partie ['30 min', '1 h', 'Illimité']
            gameTime: 'Illimité',
            // @vuese
            // Nombre de joueurs souhaités ('target') pour la partie (matchmaking)
            nbPlayers: 0,
            // @vuese
            // Liste des invitations à rejoindre le lobby de quelqu'un d'autre
            lobbyInvitations: [],
            // @vuese
            // Recherche dans la liste d'amis
            searchFriends: '',
            // @vuese
            // Ressources audio utilisées dans le Lobby
            audio: {
                background: null,
                sfx: {
                    notification: null,
                    success: null,
                    error: null,
                    buttonClick: null
                }
            }
        }
    },
    watch: {
        /**
         * @vuese
         * Rafraîchit la liste d'amis en fonction de la recherche
         */
        searchFriends() {
            for (const friend of this.friends)
                friend.showInSearch = friend.nickname.toUpperCase().includes(this.searchFriends.toUpperCase());
        }
    },
    methods: {
        /**
         * @vuese
         * Clic sur le bouton "Jouer" : lance la partie (ou recherche une partie selon nos critères) OU annule la recherche de partie (selon l'état du bouton)
         * Les flèches de paramètres du lobby sont également masquées durant la recherche d'une partie.
         */
        play() {
            this.audio.sfx.buttonClick.play();
            if (this.hostID === this.loggedUser.id) {
                if (!this.playBtn.loading) {
                    this.leftNbJ = false;
                    this.rightNbJ = false;
                    this.leftGameTime = false;
                    this.rightGameTime = false;
                    this.socket.emit('lobbyPlayReq');
                } else {
                    if (this.nbPlayers > 2)
                        this.leftNbJ = true;
                    if (this.nbPlayers < 8)
                        this.rightNbJ = true;
                    if (this.gameTime != '30 min')
                        this.leftGameTime = true;
                    if (this.gameTime != 'Illimité')
                        this.rightGameTime = true;
                    this.socket.emit('lobbyCancelPlayReq');
                }
            }
        },

        /**
         * @vuese
         * Récupère le pseudo d'un joueur à partir de son ID
         * @arg ID du joueur
         */
        idToNick(id) {
            for (const row of this.players) {
                if (row.id === id)
                    return row.nickname;
            }
        },

        /**
         * @vuese
         * Diminue le nombre de joueurs souhaités pour la partie (min : min(2, [nb joueurs déjà dans le lobby]))
         */
        leftNbJClick() {
            this.audio.sfx.buttonClick.play();
            if (this.hostID === this.loggedUser.id
                && this.nbPlayers > 2 && this.nbPlayers > this.players.length) {
                this.rightNbJ = true;

                this.nbPlayers--;
                this.socket.emit('lobbyChangeTargetUsersNbReq', { nb: this.nbPlayers });

                if (this.nbPlayers === 2 || this.nbPlayers === this.players.length) {
                    this.leftNbJ = false;
                }
            }
        },

        /**
         * @vuese
         * Augmente le nombre de joueurs souhaités pour la partie (max : 8)
         */
        rightNbJClick() {
            this.audio.sfx.buttonClick.play();
            if (this.hostID === this.loggedUser.id && this.nbPlayers < 8) {
                this.leftNbJ = true;

                this.nbPlayers++;
                this.socket.emit('lobbyChangeTargetUsersNbReq', { nb: this.nbPlayers });

                if (this.nbPlayers >= 8)
                    this.rightNbJ = false;
            }
        },

        /**
         * @vuese
         * Diminue le temps souhaité pour la partie
         */
        leftGameTimeClick() {
            this.audio.sfx.buttonClick.play();
            this.leftGameTime = true;
            this.rightGameTime = true;
            let dur;

            if (this.gameTime === '1 h') {
                this.gameTime = '30 min'
                this.leftGameTime = false;
                dur = 30;
            } else if (this.gameTime === 'Illimité') {
                this.gameTime = '1 h';
                dur = 60;
            }

            this.socket.emit('lobbyChangeDurationReq' , { newDuration: dur });
        },

        /**
         * @vuese
         * Augmente le temps souhaité pour la partie
         */
        rightGameTimeClick() {
            this.audio.sfx.buttonClick.play();
            this.leftGameTime = true;
            this.rightGameTime = true;
            let dur;

            if (this.gameTime === '1 h') {
                this.gameTime = 'Illimité';
                this.rightGameTime = false;
                dur = null;
            } else if (this.gameTime === '30 min') {
                this.gameTime = '1 h';
                dur = 60;
            }

            this.socket.emit('lobbyChangeDurationReq' , { newDuration: dur });
        },

        /**
         * @vuese
         * Supprime une invitation à rejoindre un lobby
         * @arg ID de l'invitation à supprimer
         */
        deleteLobbyInvitation(id) {
            for (const i in this.lobbyInvitations) {
                if (this.lobbyInvitations[i].id === id) {
                    this.lobbyInvitations.splice(i, 1);
                }
            }
        },

        /**
         * @vuese
         * Accepte une invitation à rejoindre un lobby (et la supprime de l'écran)
         * @arg ID de l'invitation à accepter
         */
        acceptLobbyInvitation(id) {
            this.socket.emit("lobbyInvitationActionReq", { invitationID: id, accept: true });
            this.deleteLobbyInvitation(id);
        },

        /**
         * @vuese
         * Rejette une invitation à rejoindre un lobby (i.e. la supprime)
         * @arg ID de l'invitation à rejeter
         */
        rejectLobbyInvitation(id) {
            this.socket.emit("lobbyInvitationActionReq", { invitationID: id, accept: false });
            this.deleteLobbyInvitation(id);
        },

        /**
         * @vuese
         * Envoie le formulaire d'ajout d'ami au serveur
         */
        addFriend() {
            this.audio.sfx.buttonClick.play();
            if (this.addFriendForm.nickname !== '') {
                this.socket.emit('lobbyFriendInvitationSendReq', { nickname: this.addFriendForm.nickname });
                this.addFriendForm.nickname = '';
            }
        },

        /**
         * @vuese
         * Supprime une invitation d'ami
         * @arg ID du joueur dont l'invitation en ami sera supprimée
         */
        deleteFriendInvitation(friendId) {
            for (const i in this.friendsInvitations) {
                if (this.friendsInvitations[i].id === friendId) {
                    this.friendsInvitations.splice(i, 1);
                }
            }
        },

        /**
         * @vuese
         * Accepte une invitation d'ami (et la supprime de l'affichage)
         * @arg ID du joueur accepté en ami ; Pseudo du joueur accepté en ami
         */
        acceptFriendInvitation(friendId, nickname) {
            this.audio.sfx.buttonClick.play();
            this.socket.emit('lobbyFriendInvitationActionReq', { action: 1, nickname: nickname });
            this.deleteFriendInvitation(friendId);
            this.friends = [];
            this.socket.emit('lobbyFriendListReq');
        },

        /**
         * @vuese
         * Rejette une invitation d'ami (et la supprime de l'affichage)
         * @arg ID du joueur refusé en ami ; Pseudo du joueur refusé en ami
         */
        rejectFriendInvitation(friendId, nickname) {
            this.audio.sfx.buttonClick.play();
            this.socket.emit("lobbyFriendInvitationActionReq", { action: 0, nickname: nickname });
            this.deleteFriendInvitation(friendId);
        },

        /**
         * @vuese
         * Envoie une invitation dans le lobby à un ami
         * @arg ID du joueur que l'on souhaite inviter
         */
        inviteFriendInLobby(id) {
            this.audio.sfx.buttonClick.play();
            this.socket.emit("lobbyInvitationReq", { friendID: id });
        },

        /**
         * @vuese
         * Expulse un joueur de notre lobby
         * @arg ID du joueur à expulser
         */
        kickPlayerFromLobby(id) {
            this.socket.emit('lobbyKickReq', { userToKickID: id });
        },

        /**
         * @vuese
         * Change les paramètres d'affichage (accessibilité des boutons) pour que l'on puisse - en tant qu'hôte - gérer le lobby
         */
        imHost() {
            this.leftNbJ = true;
            this.rightNbJ = true;
            this.leftGameTime = true;
            if (this.nbPlayers === 2 || this.nbPlayers === this.players.length)
                this.leftNbJ = false;
            if (this.nbPlayers === 8)
                this.rightNbJ = false;

            this.playBtn.disabled = false;
        },

        /**
         * @vuese
         * Déconnexion du jeu (et redirection à l'écran d'accueil)
         */
        logout() {
            this.audio.sfx.buttonClick.play();
            this.socket.close();
            this.$store.dispatch('logout').then(() => {
                this.$router.push('/');
            });
        },

        /**
         * @vuese
         * Lance la musique de fond du lobby
         */
        playMusic() {
            this.audio.background = new Howl({
                src: '/assets/audio/musics/lobby-time-by-kevin-macleod-from-filmmusic-io.mp3',
                volume: this.loggedUser.settings.musicLevel / 100,
                autoplay: true,
                loop: true
            });
        },

        /**
         * @vuese
         * Modifie le volume de la musique
         * @arg Pourcentage du volume (entier de 0 à 100)
         */
        setMusicLevel(level) {
            this.audio.background.volume(level / 100);
        },

        /**
         * @vuese
         * Coupe la musique de fond (en fondu)
         */
        stopMusic() {
            this.audio.background.fade(this.audio.background.volume(), 0, 500);
            this.audio.background.stop();
        },

        /**
         * @vuese
         * Précharge tous les effets sonores (SFX) du jeu
         */
        loadSfx() {
            this.audio.sfx.notification = new Howl({
                src: ['/assets/audio/sfx/clearly.mp3'],
                autoplay: false,
                loop: false,
                volume: this.loggedUser.settings.sfxLevel / 100
            });
            this.audio.sfx.success = new Howl({
                src: ['/assets/audio/sfx/hollow.mp3'],
                autoplay: false,
                loop: false,
                volume: this.loggedUser.settings.sfxLevel / 100
            });
            this.audio.sfx.error = new Howl({
                src: ['/assets/audio/sfx/glitch-in-the-matrix.mp3'],
                autoplay: false,
                loop: false,
                volume: this.loggedUser.settings.sfxLevel / 100
            });
            this.audio.sfx.buttonClick = new Howl({
                src: ['/assets/audio/sfx/buttonClick.mp3'],
                autoplay: false,
                loop: false,
                volume: this.loggedUser.settings.sfxLevel / 100
            });
        },

        /**
         * @vuese
         * Modifie le volume des effets sonores
         * @arg Pourcentage du volume (entier de 0 à 100)
         */
        setSfxLevel(level) {
            for (let [key] of Object.entries(this.audio.sfx)) {
                if (typeof this.audio.sfx[key].volume === 'function')
                    this.audio.sfx[key].volume(level / 100);
            }
        },

        /**
         * @vuese
         * Envoie au serveur une requête de mise à jour du profil avec les informations du formulaire
         */
        updateProfile() {
            this.audio.sfx.buttonClick.play();
            this.editProfile.loading = true;
            this.socket.emit('lobbyUpdateProfileReq', this.editProfile);

            if (this.editProfile.avatar && this.siofu)
                this.siofu.submitFiles([this.editProfile.avatar]);
        },

        /**
         * @vuese
         * Vérifie si l'avatar a été modifié dans la zone de fichiers du formulaire d'édition du profil
         * @arg Evénement déclenché au changement de l'avatar
         */
        processAvatar(event) {
            if (typeof event.target.files[0] !== 'undefined')
                this.editProfile.avatar = event.target.files[0];
            this.audio.sfx.buttonClick.play();
        }
    },
    beforeDestroy() {
        this.stopMusic();
        this.socket.close();
    },
    mounted() {
        this.socket = io.connect(this.$store.getters.serverUrl, {
                        query: 'token=' + this.$store.getters.jwt,
                        path: '/socket.io',
                        secure: true
                    });

        this.$refs.chat.initSocket();

        this.playMusic();
        this.loadSfx();

        this.editProfile.nickname = this.loggedUser.nickname;
        this.editProfile.email = this.loggedUser.email;

        this.$parent.initSocketConnexion(this.socket);

        this.socket.on('lobbyCreatedRes', (res) => {
            this.hostID = this.loggedUser.id;
            this.nbPlayers = res.targetUsersNb;
            this.players = [this.loggedUser];

            this.imHost();
        });

        this.socket.on('lobbyJoinedRes', (res) => {
            this.players = [];
            this.nbPlayers = res.targetUsersNb;
            this.hostID = res.users[0].id;

            for (const usr of res.users) {
                usr.avatar = this.$store.getters.serverUrl + usr.avatar;
                this.players.push(usr);
            }

            this.leftNbJ = false;
            this.rightNbJ = false;
            this.leftGameTime = false;
            this.rightGameTime = false;
            this.playBtn.disabled = true;

            if (res.duration === 30)
                this.gameTime = '30 min';
            else if (res.duration === 60)
                this.gameTime = '1 h';
            else
                this.gameTime = 'Illimité';

            for (const mess of res.messages)
                this.$refs.chat.messages.push(mess);
        });

        // JOUER / ANNULER / PARTIE TROUVÉE
        this.socket.on('lobbyPlayRes', (res) => {
            if (res.error) {
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
                this.playBtn.loading = false;
                this.playBtn.text = 'JOUER !';
            } else {
                this.playBtn.loading = true;
                if (this.hostID === this.loggedUser.id)
                    this.playBtn.text = 'ANNULER ...';
                else
                    this.playBtn.text = 'RECHERCHE ...';
            }
        });

        this.socket.on('lobbyCancelPlayRes', (res) => {
            if (!res.error)
                this.playBtn.text = 'JOUER !';

            if (res.error)
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
            else {
                this.playBtn.loading = false;
                this.playBtn.text = 'JOUER !';
            }
        });

        this.socket.on('lobbyGameFoundRes', () => {
            this.stopMusic();
            setTimeout(() => {
                this.$router.push('Game');
            }, 500);
        });


        /** Système de gestion d'amis
         * Vocabulaire :
         *  Pending: demande reçue besoin de valider/refuser
         *  Requested : demande envoyée en attente de validation/refus
         */
        // demande de la liste d'amis
        this.socket.emit('lobbyFriendListReq');
        this.socket.on('lobbyFriendListRes', (res) => {
            this.friends = [];
            for (const i in res.friends) {
                res.friends[i].avatar = this.$store.getters.serverUrl + res.friends[i].avatar
                res.friends[i].showInSearch = true;
                this.friends.push(res.friends[i]);
            }
        })

        this.socket.emit('lobbyPendingFriendListReq');
        this.socket.on('lobbyPendingFriendListRes', (res) => {
            this.friendsInvitations = res.friends;
        })

        this.socket.emit('lobbyRequestedFriendListReq');


        /** Système d'interactions avec les amis
         */

        // récéption d'une demande d'ami
        this.socket.on('lobbyFriendInvitationReceivedRes', (res) => {
            this.audio.sfx.notification.play();
            this.friendsInvitations.push({id: res.id, nickname: res.nickname});
        });

        //Invitation d'un amis pour rejoindre son lobby
        this.socket.on('lobbyInvitationReceivedRes', (res) => {
            this.audio.sfx.notification.play();
            this.lobbyInvitations.push({id: res.invitationID, friendNickname: res.senderFriendNickname});
        });


        /**Gestion du lobby
         */
        this.socket.on('lobbyUserJoinedRes', (res) => {
            this.audio.sfx.success.play();

            this.players.push({ id: res.id, nickname: res.nickname, avatar: this.$store.getters.serverUrl + res.avatar });
            
            if (this.nbPlayers < this.players.length)
                this.nbPlayers = this.players.length;
        });

        this.socket.on('lobbyUserLeftRes', (res) => {
            this.audio.sfx.error.play();
            if (res.userID === this.loggedUser.id) {
                // j'ai été KICK
                this.socket.emit('lobbyReadyReq');
                return;
            }

            this.hostID = res.hostID;

            // supprimer de la liste dans grouplist
            for (const i in this.players) {
                if (this.players[i].id == res.userID) {
                    this.players.splice(i, 1);
                    break;
                }
            }

            if (this.hostID === this.loggedUser.id)
                this.imHost();
        });

        this.socket.on('lobbyTargetUsersNbChangedRes', (res) => {
            this.nbPlayers = res.nb;
        });

        this.socket.on('lobbyDurationChangedRes', (res) => {
            if (res.newDuration === 30)
                this.gameTime = '30 min';
            else if (res.newDuration === 60)
                this.gameTime = '1 h';
            else
                this.gameTime = 'Illimité'
        });

        this.socket.on('lobbyPlayRes', (res) => {
            if (res.error !== 0) {
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
                this.playBtn.loading = false;
                // this.playBtn.disabled = false;
                this.playBtn.text = "JOUER!";
            }
        });

        this.socket.on('lobbyGameFoundRes', () => {
            this.stopMusic();
            setTimeout(() => {
                this.$router.push('/game');
            }, 500);
        });

        /**Vérifications des Res asynchrones
        */
        this.socket.on('lobbyFriendInvitationSendRes', (res) => {
            if (res.error === 0) {
                this.audio.sfx.success.play();
                this.$parent.toast('Invitation envoyée', 'success', 3);
                $('#addFriendModal').modal('hide');
            } else {
                this.audio.sfx.error.play();
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
            }
        });

        this.socket.on("lobbyInvitationRes", (res) => {
            if (res.error === 0)
                this.$parent.toast('Invitation envoyée', 'success', 3);
            else // hôte uniquement
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
        });

        this.socket.on("lobbyFriendInvitationActionRes", (res) => {
            if (res.error !== 0)
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
        });

        this.socket.on("lobbyInvitationActionRes", (res) => {
            if (res.error === 0)
                this.socket.emit('lobbyReadyReq');
            else
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
        });

        this.socket.on("lobbyFriendInvitationAcceptedRes", (res) => {
            this.friends.push({
                id: res.id,
                nickname: res.nickname,
                avatar: this.$store.getters.serverUrl + res.avatar,
                showInSearch: true
            });
        });

        this.socket.on("lobbyKickRes", (res) => {
            if (res.error !== 0)
                this.$parent.toast(`Erreur ${res.status}`, 'danger', 5);
        });

        // On peut se reconnecter à une partie en cours
        this.socket.on('canReconnectToGame', () => {
            this.loading = true;
            this.socket.close();

            setTimeout(() => {
                this.$router.push('/game');
                this.loading = false;
            }, 1000);
        });


        // Update du profil
        this.socket.on('lobbyUpdateProfileRes', (res) => {
            if (res.error !== 0) {
                this.$parent.toast(res.status, 'danger', 5);
            } else {
                if (res.user) {
                    this.$store.dispatch('updateProfile', {
                        nickname: res.user.nickname,
                        email: res.user.email
                    });
                }

                this.$parent.toast('Profil mis à jour', 'success', 3);
                $('#userSettingsModal').modal('hide');
            }

            this.editProfile.loading = false;
        });

        this.socket.on('lobbyUserNicknameUpdatedRes', (res) => {
            for (const i in this.players) {
                if (this.players[i].id == res.id) {
                    this.$set(this.players[i], 'nickname', res.nickname);
                    break;
                }
            }

            for (const i in this.friends) {
                if (this.friends[i].id == res.id) {
                    this.$set(this.friends[i], 'nickname', res.nickname);
                    break;
                }
            }
        });

        /****** GESTION AVATAR ******/
        this.siofu = new SocketIOFileUpload(this.socket);

        this.siofu.addEventListener("error", (event) => {
            if (event.code === 0)
                this.$parent.toast('Erreur avatar : image trop lourde (> 1Mo)', 'danger', 3);
        });

        this.socket.on('lobbyUserAvatarUpdatedRes', (res) => {
            const d = new Date();
            const timeCacheRefresh = d.getTime();
            const imgPath = this.$store.getters.serverUrl + res.path;
            const imgPathCache = imgPath + '?' + timeCacheRefresh;
            const playerID = res.id;

            if (playerID == this.loggedUser.id) {
                this.$store.dispatch('updateAvatar', {
                    avatarPath: imgPath
                });
            }

            for (const i in this.players) {
                if (this.players[i].id == playerID) {
                    this.$set(this.players[i], 'avatar', imgPathCache);
                    break;
                }
            }

            for (const i in this.friends) {
                if (this.friends[i].id == playerID) {
                    this.$set(this.friends[i], 'avatar', imgPathCache);
                    break;
                }
            }
        });

        this.socket.on('lobbyUpdateAvatarRes', (res) => {
            if (res.error !== 0)
                this.$parent.toast(res.status, 'danger', 3);
        });

        $('.modal').on('shown.bs.modal', function() {
            $(this).find('input').first().focus();
        });

        this.socket.emit('lobbyReadyReq');
    }
}
</script>
